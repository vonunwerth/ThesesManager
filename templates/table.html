{% extends "base.html" %}

{% block content %}
<div class="dashboard-header" style="display: flex; justify-content: space-between; align-items: flex-end;">
    <div>
        <h2>Database Table View</h2>
        <p>A raw grid view of all database entries for quick administration.</p>
    </div>
    <a href="{{ url_for('index') }}" class="btn btn-secondary">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="19" y1="12" x2="5" y2="12"></line>
            <polyline points="12 19 5 12 12 5"></polyline>
        </svg>
        Back to Dashboard
    </a>
</div>

<div class="glass-panel" style="padding: 1.5rem; overflow-x: auto;">
    <table class="db-table" style="width: 100%; text-align: left; border-collapse: collapse; min-width: 2400px;">
        <thead>
            <tr style="border-bottom: 1px solid var(--border-color); color: var(--text-secondary);">
                <th style="padding: 1rem 0.5rem;">ID</th>
                <th style="padding: 1rem 0.5rem;">First Name</th>
                <th style="padding: 1rem 0.5rem;">Last Name</th>
                <th style="padding: 1rem 0.5rem;">Matriculation</th>
                <th style="padding: 1rem 0.5rem;">Program</th>
                <th style="padding: 1rem 0.5rem;">Degree</th>
                <th style="padding: 1rem 0.5rem;">Title</th>
                <th style="padding: 1rem 0.5rem;">Status</th>
                <th style="padding: 1rem 0.5rem;">Betreuer</th>
                <th style="padding: 1rem 0.5rem;">Kennziffer</th>
                <th style="padding: 1rem 0.5rem;">Anmeldedatum</th>
                <th style="padding: 1rem 0.5rem;">Abgabedatum</th>
                <th style="padding: 1rem 0.5rem;">Regeltermin</th>
                <th style="padding: 1rem 0.5rem;">Expose URL</th>
                <th style="padding: 1rem 0.5rem;">Thesis URL</th>
                <th style="padding: 1rem 0.5rem;">Cloudfolder URL</th>
                <th style="padding: 1rem 0.5rem; text-align: center;">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for student in students %}
            <tr class="table-row" data-id="{{ student.id }}"
                style="border-bottom: 1px solid rgba(255,255,255,0.05); transition: background-color 0.2s;">
                <td style="padding: 0.75rem 0.5rem;">{{ student.id }}</td>
                <td style="padding: 0.75rem 0.5rem;"><input type="text" class="table-input" data-field="first_name"
                        value="{{ student.first_name }}"></td>
                <td style="padding: 0.75rem 0.5rem;"><input type="text" class="table-input" data-field="last_name"
                        value="{{ student.last_name }}"></td>
                <td style="padding: 0.75rem 0.5rem;"><input type="text" class="table-input"
                        data-field="matriculation_number" value="{{ student.matriculation_number }}"></td>
                <td style="padding: 0.75rem 0.5rem;"><input type="text" class="table-input" data-field="program"
                        value="{{ student.program }}"></td>
                <td style="padding: 0.75rem 0.5rem;">
                    <select class="table-input" data-field="degree_type">
                        <option value="Bachelor" {% if student.degree_type=='Bachelor' %}selected{% endif %}>Bachelor
                        </option>
                        <option value="Master" {% if student.degree_type=='Master' %}selected{% endif %}>Master</option>
                    </select>
                </td>
                <td style="padding: 0.75rem 0.5rem;"><input type="text" class="table-input" data-field="title"
                        value="{{ student.title }}"></td>
                <td style="padding: 0.75rem 0.5rem;">
                    <select class="table-input" data-field="status">
                        <option value="Erste Idee" {% if student.status=='Erste Idee' %}selected{% endif %}>Erste Idee
                        </option>
                        <option value="Schreibt Expose" {% if student.status=='Schreibt Expose' %}selected{% endif %}>
                            Schreibt Exposé</option>
                        <option value="Expose wartet auf Review" {% if student.status=='Expose wartet auf Review'
                            %}selected{% endif %}>Exposé wartet auf Review</option>
                        <option value="Anmeldung eingereicht" {% if student.status=='Anmeldung eingereicht' %}selected{%
                            endif %}>Anmeldung eingereicht</option>
                        <option value="Angemeldet" {% if student.status=='Angemeldet' %}selected{% endif %}>Angemeldet
                        </option>
                        <option value="Abgegeben" {% if student.status=='Abgegeben' %}selected{% endif %}>Abgegeben
                        </option>
                        <option value="Bewertet" {% if student.status=='Bewertet' %}selected{% endif %}>Bewertet
                        </option>
                    </select>
                </td>
                <td style="padding: 0.75rem 0.5rem;"><input type="text" class="table-input" data-field="supervisor"
                        value="{{ student.supervisor or '' }}"></td>
                <td style="padding: 0.75rem 0.5rem;"><input type="text" class="table-input" data-field="kennziffer"
                        value="{{ student.kennziffer or '' }}"></td>
                <td style="padding: 0.75rem 0.5rem;"><input type="date" class="table-input" data-field="start_date"
                        value="{{ student.start_date.strftime('%Y-%m-%d') if student.start_date else '' }}"></td>
                <td style="padding: 0.75rem 0.5rem;"><input type="date" class="table-input" data-field="submission_date"
                        value="{{ student.submission_date.strftime('%Y-%m-%d') if student.submission_date else '' }}">
                </td>
                <td style="padding: 0.75rem 0.5rem;"><input type="text" class="table-input" data-field="regular_meeting"
                        value="{{ student.regular_meeting or '' }}"></td>
                <td style="padding: 0.75rem 0.5rem;"><input type="text" class="table-input" data-field="expose_url"
                        value="{{ student.expose_url or '' }}"></td>
                <td style="padding: 0.75rem 0.5rem;"><input type="text" class="table-input" data-field="thesis_url"
                        value="{{ student.thesis_url or '' }}"></td>
                <td style="padding: 0.75rem 0.5rem;"><input type="text" class="table-input" data-field="cloudfolder_url"
                        value="{{ student.cloudfolder_url or '' }}"></td>
                <td style="padding: 0.75rem 0.5rem; text-align: center;">
                    <button class="icon-btn delete-table-row" title="Delete Student" style="color: #ef4444;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M3 6h18"></path>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2">
                            </path>
                        </svg>
                    </button>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="17" style="padding: 2rem; text-align: center; color: var(--text-secondary);">No students
                    found in the database.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<style>
    .table-input {
        background: transparent;
        border: 1px solid transparent;
        color: var(--text-primary);
        width: 100%;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
    }

    .table-input:hover,
    .table-input:focus {
        background: rgba(15, 23, 42, 0.5);
        border-color: var(--border-color);
        outline: none;
    }

    .table-row:hover {
        background-color: rgba(255, 255, 255, 0.02);
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Save changes when leaving an input field
        document.querySelectorAll('.table-input').forEach(input => {
            input.addEventListener('change', (e) => {
                const row = e.target.closest('tr');
                const studentId = row.getAttribute('data-id');
                const field = e.target.getAttribute('data-field');
                const value = e.target.value;

                // Optional enhancement: add a tiny visual flash that it's saving
                e.target.style.borderColor = 'var(--primary-color)';

                const payload = {};
                payload[field] = value;

                fetch(`/api/students/${studentId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            setTimeout(() => e.target.style.borderColor = 'transparent', 500);
                        } else {
                            e.target.style.borderColor = '#ef4444'; // Red on error
                        }
                    })
                    .catch(() => e.target.style.borderColor = '#ef4444');
            });
        });

        // Handle delete row
        document.querySelectorAll('.delete-table-row').forEach(btn => {
            btn.addEventListener('click', (e) => {
                if (confirm('Are you sure you want to completely delete this student? This cannot be undone.')) {
                    const row = e.target.closest('tr');
                    const studentId = row.getAttribute('data-id');

                    fetch(`/api/students/${studentId}`, {
                        method: 'DELETE'
                    })
                        .then(res => res.json())
                        .then(data => {
                            if (data.success) {
                                row.remove();
                            }
                        });
                }
            });
        });
    });
</script>
{% endblock %}